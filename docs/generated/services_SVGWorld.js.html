<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/SVGWorld.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/SVGWorld.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { SVG } from '@svgdotjs/svg.js';

/**
 * SVGWorld - Objeto "mundo" centralizado para manejo de SVG
 *
 * Resuelve el problema de transformaciones entre m煤ltiples sistemas de coordenadas:
 * 1. Coordenadas SVG (viewBox) - El espacio de coordenadas del SVG original
 * 2. Coordenadas del viewport (pan/zoom) - La transformaci贸n aplicada por el usuario
 * 3. Coordenadas de pantalla - Las coordenadas del navegador donde ocurren eventos
 *
 * Esta clase act煤a como un objeto intermedio "en memoria" que mantiene
 * la representaci贸n del estado del SVG y proporciona m茅todos para conversi贸n
 * de coordenadas y manipulaci贸n de elementos de forma unificada.
 */
export class SVGWorld {
  constructor() {
    this.svgInstance = null;
    this.svgElement = null;
    this.viewport = { scale: 1, x: 0, y: 0 };
    this.containerElement = null;
  }

  /**
   * Inicializa el mundo SVG con un elemento DOM
   * @param {HTMLElement} svgElement - Elemento SVG del DOM
   * @param {HTMLElement} containerElement - Contenedor para c谩lculos de offset
   */
  initialize(svgElement, containerElement = null) {
    if (!svgElement) {
      throw new Error('SVGWorld: Se requiere un elemento SVG v谩lido');
    }

    this.svgElement = svgElement;
    this.containerElement = containerElement;

    // Adoptar el elemento SVG existente con SVG.js
    this.svgInstance = SVG(svgElement);

    console.log(' SVGWorld inicializado correctamente');
    return this;
  }

  /**
   * Actualiza el estado del viewport (pan/zoom)
   * @param {Object} viewport - { scale, x, y }
   */
  updateViewport(viewport) {
    if (viewport) {
      this.viewport = { ...this.viewport, ...viewport };
    }
  }

  /**
   * Convierte coordenadas de pantalla a coordenadas SVG
   * Usa la matriz de transformaci贸n del SVG (getScreenCTM) para precisi贸n
   *
   * @param {number} screenX - Coordenada X de pantalla
   * @param {number} screenY - Coordenada Y de pantalla
   * @returns {Object} { x, y } en coordenadas SVG
   */
  screenToSVG(screenX, screenY) {
    if (!this.svgElement) {
      console.warn('SVGWorld: SVG no inicializado');
      return { x: screenX, y: screenY };
    }

    try {
      // Crear un punto SVG
      const svgPoint = this.svgElement.createSVGPoint();
      svgPoint.x = screenX;
      svgPoint.y = screenY;

      // Obtener la matriz de transformaci贸n de pantalla a SVG
      const ctm = this.svgElement.getScreenCTM();
      if (!ctm) {
        console.warn('SVGWorld: No se pudo obtener CTM');
        return { x: screenX, y: screenY };
      }

      // Transformar el punto
      const transformedPoint = svgPoint.matrixTransform(ctm.inverse());

      return {
        x: transformedPoint.x,
        y: transformedPoint.y
      };
    } catch (error) {
      console.error('SVGWorld: Error en screenToSVG', error);
      return { x: screenX, y: screenY };
    }
  }

  /**
   * Convierte coordenadas SVG a coordenadas de pantalla
   *
   * @param {number} svgX - Coordenada X en SVG
   * @param {number} svgY - Coordenada Y en SVG
   * @returns {Object} { x, y } en coordenadas de pantalla
   */
  svgToScreen(svgX, svgY) {
    if (!this.svgElement) {
      console.warn('SVGWorld: SVG no inicializado');
      return { x: svgX, y: svgY };
    }

    try {
      const svgPoint = this.svgElement.createSVGPoint();
      svgPoint.x = svgX;
      svgPoint.y = svgY;

      const ctm = this.svgElement.getScreenCTM();
      if (!ctm) {
        console.warn('SVGWorld: No se pudo obtener CTM');
        return { x: svgX, y: svgY };
      }

      const transformedPoint = svgPoint.matrixTransform(ctm);

      return {
        x: transformedPoint.x,
        y: transformedPoint.y
      };
    } catch (error) {
      console.error('SVGWorld: Error en svgToScreen', error);
      return { x: svgX, y: svgY };
    }
  }

  /**
   * Convierte un delta (diferencia) de pantalla a delta SVG
   * til para drag &amp; drop y manipulaci贸n de elementos
   *
   * @param {number} deltaX - Delta X en pantalla
   * @param {number} deltaY - Delta Y en pantalla
   * @returns {Object} { dx, dy } en unidades SVG
   */
  screenDeltaToSVGDelta(deltaX, deltaY) {
    if (!this.svgElement) {
      return { dx: deltaX, dy: deltaY };
    }

    try {
      const ctm = this.svgElement.getScreenCTM();
      if (!ctm) {
        return { dx: deltaX, dy: deltaY };
      }

      // Para deltas, solo necesitamos la escala de la matriz
      // No necesitamos la traslaci贸n
      const scale = Math.sqrt(ctm.a * ctm.a + ctm.b * ctm.b);

      return {
        dx: deltaX / scale,
        dy: deltaY / scale
      };
    } catch (error) {
      console.error('SVGWorld: Error en screenDeltaToSVGDelta', error);
      return { dx: deltaX, dy: deltaY };
    }
  }

  /**
   * Encuentra un elemento por ID usando SVG.js
   * @param {string} id - ID del elemento
   * @returns {Object|null} Elemento SVG.js o null
   */
  findElementById(id) {
    if (!this.svgInstance) return null;
    return this.svgInstance.findOne(`#${id}`);
  }

  /**
   * Obtiene el elemento DOM nativo por ID
   * @param {string} id - ID del elemento
   * @returns {Element|null} Elemento DOM o null
   */
  getElementByIdDOM(id) {
    if (!this.svgElement) return null;
    return this.svgElement.querySelector(`#${id}`);
  }

  /**
   * Obtiene el bounding box de un elemento en coordenadas SVG
   * @param {Element|string} element - Elemento DOM o ID
   * @returns {Object} { x, y, width, height }
   */
  getElementBBox(element) {
    try {
      const el = typeof element === 'string'
        ? this.getElementByIdDOM(element)
        : element;

      if (!el || !el.getBBox) {
        return { x: 0, y: 0, width: 0, height: 0 };
      }

      return el.getBBox();
    } catch (error) {
      console.error('SVGWorld: Error obteniendo bbox', error);
      return { x: 0, y: 0, width: 0, height: 0 };
    }
  }

  /**
   * Aplica una transformaci贸n a un elemento usando SVG.js
   * @param {string|Element} element - ID o elemento DOM
   * @param {Object} transform - { x, y, scaleX, scaleY, rotation }
   */
  applyTransform(element, transform) {
    const el = typeof element === 'string'
      ? this.findElementById(element)
      : SVG(element);

    if (!el) return;

    try {
      const { x = 0, y = 0, scaleX = 1, scaleY = 1, rotation = 0 } = transform;

      // Usar el sistema de transformaciones de SVG.js
      el.transform({
        translateX: x,
        translateY: y,
        scaleX,
        scaleY,
        rotate: rotation
      });
    } catch (error) {
      console.error('SVGWorld: Error aplicando transformaci贸n', error);
    }
  }

  /**
   * Mueve un elemento por un delta espec铆fico
   * @param {Element} element - Elemento DOM
   * @param {number} deltaX - Delta X en unidades SVG
   * @param {number} deltaY - Delta Y en unidades SVG
   */
  moveElement(element, deltaX, deltaY) {
    if (!element) return;

    try {
      const currentTransform = element.getAttribute('transform') || '';
      const translateMatch = currentTransform.match(/translate\(([^,]+),\s*([^)]+)\)/);

      let currentX = 0;
      let currentY = 0;

      if (translateMatch) {
        currentX = parseFloat(translateMatch[1]) || 0;
        currentY = parseFloat(translateMatch[2]) || 0;
      }

      const newX = currentX + deltaX;
      const newY = currentY + deltaY;

      // Actualizar o agregar translate
      let newTransform = currentTransform;
      if (translateMatch) {
        newTransform = currentTransform.replace(
          /translate\([^)]+\)/,
          `translate(${newX}, ${newY})`
        );
      } else {
        newTransform = `translate(${newX}, ${newY}) ${currentTransform}`.trim();
      }

      element.setAttribute('transform', newTransform);
    } catch (error) {
      console.error('SVGWorld: Error moviendo elemento', error);
    }
  }

  /**
   * Limpia los recursos
   */
  destroy() {
    this.svgInstance = null;
    this.svgElement = null;
    this.containerElement = null;
    console.log(' SVGWorld destruido');
  }
}

/**
 * Factory function para crear instancias de SVGWorld
 */
export function createSVGWorld() {
  return new SVGWorld();
}

export default SVGWorld;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CoordinateTransformer.html">CoordinateTransformer</a></li><li><a href="PathDataProcessor.html">PathDataProcessor</a></li><li><a href="SVGOptimizer.html">SVGOptimizer</a></li><li><a href="SVGWorld.html">SVGWorld</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AdvancedTools">AdvancedTools</a></li><li><a href="global.html#BezierHandleEditor">BezierHandleEditor</a></li><li><a href="global.html#CodeView">CodeView</a></li><li><a href="global.html#Container">Container</a></li><li><a href="global.html#DEFAULT_CONFIG">DEFAULT_CONFIG</a></li><li><a href="global.html#FileLoadDemo">FileLoadDemo</a></li><li><a href="global.html#LanguageSelector">LanguageSelector</a></li><li><a href="global.html#MousePointerIcon">MousePointerIcon</a></li><li><a href="global.html#MoveableWrapper">MoveableWrapper</a></li><li><a href="global.html#NodeEditor">NodeEditor</a></li><li><a href="global.html#PathDebugger">PathDebugger</a></li><li><a href="global.html#PerformanceMetrics">PerformanceMetrics</a></li><li><a href="global.html#SVGHierarchy">SVGHierarchy</a></li><li><a href="global.html#SVGHistory">SVGHistory</a></li><li><a href="global.html#SVGMetadataEditor">SVGMetadataEditor</a></li><li><a href="global.html#SVGViewer">SVGViewer</a></li><li><a href="global.html#SettingsModal">SettingsModal</a></li><li><a href="global.html#SettingsView">SettingsView</a></li><li><a href="global.html#StylePanel">StylePanel</a></li><li><a href="global.html#TextInput">TextInput</a></li><li><a href="global.html#absoluteToRelative">absoluteToRelative</a></li><li><a href="global.html#addNodeToPath">addNodeToPath</a></li><li><a href="global.html#applyTransform">applyTransform</a></li><li><a href="global.html#buildPathFromNodes">buildPathFromNodes</a></li><li><a href="global.html#buildPathString">buildPathString</a></li><li><a href="global.html#checkLocalStorageAvailable">checkLocalStorageAvailable</a></li><li><a href="global.html#checkSessionStorageAvailable">checkSessionStorageAvailable</a></li><li><a href="global.html#circleToPath">circleToPath</a></li><li><a href="global.html#clearLocalStorage">clearLocalStorage</a></li><li><a href="global.html#clearSessionStorage">clearSessionStorage</a></li><li><a href="global.html#closePath">closePath</a></li><li><a href="global.html#countElements">countElements</a></li><li><a href="global.html#createCoordinateTransformer">createCoordinateTransformer</a></li><li><a href="global.html#createPathDataProcessor">createPathDataProcessor</a></li><li><a href="global.html#createSVGOptimizer">createSVGOptimizer</a></li><li><a href="global.html#createSVGWorld">createSVGWorld</a></li><li><a href="global.html#ellipseToPath">ellipseToPath</a></li><li><a href="global.html#formatNumber">formatNumber</a></li><li><a href="global.html#getElementBBox">getElementBBox</a></li><li><a href="global.html#getLocalStorageSize">getLocalStorageSize</a></li><li><a href="global.html#getSessionStorageSize">getSessionStorageSize</a></li><li><a href="global.html#getTransformedBBox">getTransformedBBox</a></li><li><a href="global.html#moveElement">moveElement</a></li><li><a href="global.html#optimizeSVG">optimizeSVG</a></li><li><a href="global.html#parsePathCommand">parsePathCommand</a></li><li><a href="global.html#parsePathNodes">parsePathNodes</a></li><li><a href="global.html#parseTransform">parseTransform</a></li><li><a href="global.html#pointToHorizontalLine">pointToHorizontalLine</a></li><li><a href="global.html#pointToLineTo">pointToLineTo</a></li><li><a href="global.html#pointToMoveTo">pointToMoveTo</a></li><li><a href="global.html#pointToSmoothQuadraticBezier">pointToSmoothQuadraticBezier</a></li><li><a href="global.html#pointToVerticalLine">pointToVerticalLine</a></li><li><a href="global.html#pointsToArc">pointsToArc</a></li><li><a href="global.html#pointsToCubicBezier">pointsToCubicBezier</a></li><li><a href="global.html#pointsToPath">pointsToPath</a></li><li><a href="global.html#pointsToQuadraticBezier">pointsToQuadraticBezier</a></li><li><a href="global.html#pointsToSmoothCubicBezier">pointsToSmoothCubicBezier</a></li><li><a href="global.html#rectToPath">rectToPath</a></li><li><a href="global.html#relativeToAbsolute">relativeToAbsolute</a></li><li><a href="global.html#removeNodeFromPath">removeNodeFromPath</a></li><li><a href="global.html#rotateElement">rotateElement</a></li><li><a href="global.html#scaleElement">scaleElement</a></li><li><a href="global.html#serializeTransform">serializeTransform</a></li><li><a href="global.html#simplifyPath">simplifyPath</a></li><li><a href="global.html#svgToScreenCoords">svgToScreenCoords</a></li><li><a href="global.html#updateNodeInPath">updateNodeInPath</a></li><li><a href="global.html#useCoordinateTransformer">useCoordinateTransformer</a></li><li><a href="global.html#useHistory">useHistory</a></li><li><a href="global.html#useLocalStorage">useLocalStorage</a></li><li><a href="global.html#useMoveable">useMoveable</a></li><li><a href="global.html#usePanzoom">usePanzoom</a></li><li><a href="global.html#usePathDataProcessor">usePathDataProcessor</a></li><li><a href="global.html#usePerformance">usePerformance</a></li><li><a href="global.html#useSVGParser">useSVGParser</a></li><li><a href="global.html#useSVGStorage">useSVGStorage</a></li><li><a href="global.html#useSVGWorld">useSVGWorld</a></li><li><a href="global.html#useSessionStorage">useSessionStorage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Mon Nov 17 2025 13:59:29 GMT+1300 (New Zealand Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
